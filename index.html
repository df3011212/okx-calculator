<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OKX 槓桿獲利計算工具</title>
  <style>
    * { box-sizing: border-box }
    body {
      font-family: "Microsoft JhengHei","Noto Sans TC",sans-serif;
      font-size: 18px; padding: 20px; margin: 0;
      background: #f0f2f5; color: #333;
    }
    .container { max-width:800px; margin:auto }
    .section {
      padding:20px; border-radius:20px; margin-bottom:30px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .yellow { background:linear-gradient(to bottom right,#ffe066,#ffd700) }
    label { display:block; margin-top:15px; font-weight:600 }
    input[type="number"], input[list], select {
      width:100%; padding:14px; font-size:18px;
      margin-top:5px; border:1px solid #ccc; border-radius:12px;
    }
    .result {
      margin-top:15px; font-weight:bold;
      background:rgba(255,255,255,0.5); padding:10px 12px;
      border-radius:10px;
    }
    button {
      margin-top:10px; padding:10px 14px; font-size:16px;
      border:none; border-radius:6px; background:#007bff;
      color:#fff; cursor:pointer;
    }
    #historySidebar {
      position:fixed; top:0; right:-350px; width:320px; height:100%;
      background:#fff; box-shadow:-4px 0 10px rgba(0,0,0,0.15);
      transition:right .3s; z-index:1000; padding:20px; overflow-y:auto;
    }
    #toggleHistoryBtn {
      position:fixed; bottom:20px; right:20px; z-index:1001;
      padding:12px 16px; font-size:16px; background:#ffc107; color:#000;
      border:none; border-radius:30px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section yellow">
      <h2>開單速算表</h2>
      <label>選擇幣種
        <input id="symbolInput" list="symbolList"/>
        <datalist id="symbolList"></datalist>
      </label>
      <label>本金 USDT
        <input id="capital" type="number" value="1658"/>
      </label>
      <label>首次開倉價格（手動/市價切換）
        <input id="entryPrice" type="number" step="0.00001"/>
        <button id="togglePriceBtn">使用限價</button>
      </label>
      <label>保證金比例 (%)
        <input id="marginRatio" type="number" value="5"/>
      </label>
      <label>止損比例 (%)
        <input id="stoploss" type="number" value="7.52"/>
      </label>
      <label>最大虧損 USDT
        <input id="maxLoss" type="number" value="300"/>
      </label>
      <div class="result">
        槓桿倍數：<span id="leverage"></span> 倍　
        總持倉量：<span id="position"></span>
      </div>
      <div class="result">
        做多 成本：約 <span id="longMargin"></span> USDT　
        做空 成本：約 <span id="shortMargin"></span> USDT
      </div>
      <div class="result">
        剩餘可用資金：<span id="available"></span> USDT
      </div>
      <div class="result">
        維持保證金率：<span id="maintMarginRatio"></span>%
      </div>
      <div class="result">
        預估強平價格：<span id="liqPrice"></span> USDT
      </div>
      <button id="saveBtn">💾 儲存紀錄</button>
    </div>
  </div>
  <button id="toggleHistoryBtn">📚 書籤</button>
  <div id="historySidebar">
    <h3>📖 書籤紀錄</h3>
    <div id="historyList"></div>
  </div>
  <script>
    let useMarketPrice=true, currentSymbol="OP-USDT-SWAP";
    const HISTORY_KEY="okx_history_v1";

    document.getElementById("togglePriceBtn")
      .addEventListener("click",()=>{
        useMarketPrice=!useMarketPrice;
        document.getElementById("togglePriceBtn")
          .textContent=useMarketPrice?"使用限價":"使用市價";
      });

    document.getElementById("toggleHistoryBtn")
      .addEventListener("click",()=>{
        const sb=document.getElementById("historySidebar");
        sb.style.right=sb.style.right==="0px"?"-350px":"0px";
      });

    document.querySelectorAll("input")
      .forEach(i=>i.addEventListener("input",calculate));

    document.getElementById("symbolInput")
      .addEventListener("input",()=>{
        const v=document.getElementById("symbolInput").value.trim();
        if(v&&v!==currentSymbol){
          currentSymbol=v;
          fetchMarketPrice();
          calculate();
        }
      });

    document.getElementById("saveBtn")
      .addEventListener("click",saveToHistory);

    async function loadSymbols(){
      const res=await fetch("https://www.okx.com/api/v5/public/instruments?instType=SWAP");
      const data=await res.json();
      const dl=document.getElementById("symbolList");
      data.data.filter(i=>i.settleCcy==="USDT"&&i.instId.endsWith("-SWAP"))
        .forEach(i=>{
          const o=document.createElement("option");
          o.value=i.instId; dl.append(o);
        });
      document.getElementById("symbolInput").value=currentSymbol;
    }

    async function fetchMarketPrice(){
      try{
        const r=await fetch(`https://www.okx.com/api/v5/market/ticker?instId=${currentSymbol}`);
        const j=await r.json();
        const p=parseFloat(j.data?.[0]?.last);
        if(useMarketPrice&&!isNaN(p)){
          document.getElementById("entryPrice").value=p;
          calculate();
        }
      }catch{}
    }
    setInterval(fetchMarketPrice,500);

    function calculate(){
      const cap=+document.getElementById("capital").value;
      const mr=+document.getElementById("marginRatio").value/100;
      const sr=+document.getElementById("stoploss").value/100;
      const ml=+document.getElementById("maxLoss").value;
      const ep=+document.getElementById("entryPrice").value;

      const B3=cap*mr;
      const B4=ml/(cap*mr*sr);
      const position=Math.round(B3*B4);

      document.getElementById("leverage").textContent=Math.round(B4);
      document.getElementById("position").textContent=`$${position.toLocaleString()} USDT`;

      const longM=(position/B4)*1.0188;
      const shortM=(position/B4)*1.00125;
      document.getElementById("longMargin").textContent=longM.toFixed(2);
      document.getElementById("shortMargin").textContent=shortM.toFixed(2);

      document.getElementById("available").textContent=
        Math.round((cap-longM)*100)/100;

      document.getElementById("liqPrice").textContent=
        B4>0?Math.round((ep*(1-1/B4))*100000)/100000:0;

      const mReq=position*0.00803;
      document.getElementById("maintMarginRatio").textContent=
        (mReq>0?(longM/mReq)*100:0).toFixed(2);
    }

    function saveToHistory(){
      const rec={
        symbol:currentSymbol,
        capital:+document.getElementById("capital").value,
        entryPrice:+document.getElementById("entryPrice").value,
        marginRatio:+document.getElementById("marginRatio").value,
        stoploss:+document.getElementById("stoploss").value,
        maxLoss:+document.getElementById("maxLoss").value,
        time:new Date().toLocaleString()
      };
      const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]");
      h.unshift(rec); if(h.length>10)h.length=10;
      localStorage.setItem(HISTORY_KEY,JSON.stringify(h));
      renderHistory();
    }

    function renderHistory(){
      const lst=document.getElementById("historyList");
      const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]");
      lst.innerHTML="";
      h.forEach((it,i)=>{
        const lr=it.maxLoss/(it.capital*(it.marginRatio/100)*(it.stoploss/100));
        const pos=Math.round((it.capital*(it.marginRatio/100))*lr);
        const div=document.createElement("div");
        div.innerHTML=`
          <b>${it.symbol}</b> @ ${it.entryPrice}
          ｜槓桿: ${Math.round(lr)} 倍
          ｜總持倉量: $${pos.toLocaleString()} USDT
          ｜${it.time}
          <button data-i="${i}" class="app">套用</button>
          <button data-i="${i}" class="del">刪除</button>`;
        lst.append(div);
      });
      lst.querySelectorAll(".app")
         .forEach(b=>b.addEventListener("click",e=>applyHistory(+e.target.dataset.i)));
      lst.querySelectorAll(".del")
         .forEach(b=>b.addEventListener("click",e=>deleteHistory(+e.target.dataset.i)));
    }

    function applyHistory(i){
      const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]"),it=h[i];
      if(!it)return;
      document.getElementById("symbolInput").value=it.symbol;
      ["capital","entryPrice","marginRatio","stoploss","maxLoss"]
        .forEach(id=>document.getElementById(id).value=it[id]);
      currentSymbol=it.symbol; calculate();
    }

    function deleteHistory(i){
      const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]");
      h.splice(i,1); localStorage.setItem(HISTORY_KEY,JSON.stringify(h));
      renderHistory();
    }

    loadSymbols();
    renderHistory();
    calculate();
  </script>
</body>
</html>
